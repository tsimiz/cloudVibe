<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Cloud Island POC</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100%;
      background: linear-gradient(45deg, #ff9ff3, #a8edea);
      touch-action: none;
      font-family: 'Courier New', monospace;
    }
    canvas {
      display: block;
      position: absolute;
      top: 0;
      left: 0;
    }
    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, rgba(255, 159, 243, 0.9), rgba(168, 237, 234, 0.9));
      backdrop-filter: blur(10px);
      color: #fff;
      font-family: 'Courier New', monospace;
      font-size: 18px;
      text-align: center;
      z-index: 10;
      opacity: 0;
      animation: fadeIn 1s forwards;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    #overlay.fade-out {
      animation: fadeOut 0.5s forwards;
    }
    #overlay button {
      margin-top: 20px;
      font-size: 16px;
      font-weight: bold;
      padding: 12px 24px;
      background: linear-gradient(45deg, #ffd700, #ffed4e);
      color: #000;
      border: 3px solid #fff;
      border-radius: 15px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
      text-shadow: none;
    }
    #overlay button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
      background: linear-gradient(45deg, #ffed4e, #ffd700);
    }
    #hud {
      position: absolute;
      top: 15px;
      left: 15px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      font-weight: bold;
      color: #fff;
      background: linear-gradient(45deg, rgba(255, 107, 107, 0.9), rgba(255, 159, 243, 0.9));
      padding: 10px 15px;
      border-radius: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      z-index: 5;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    #level-display {
      position: absolute;
      top: 15px;
      right: 15px;
      font-family: 'Courier New', monospace;
      font-size: 16px;
      font-weight: bold;
      color: #fff;
      background: linear-gradient(45deg, rgba(116, 185, 255, 0.9), rgba(168, 237, 234, 0.9));
      padding: 10px 15px;
      border-radius: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      z-index: 5;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    #message {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 2px;
      background: linear-gradient(45deg, #ff9ff3, #a8edea, #ffd700);
      background-size: 200% 200%;
      animation: gradient 3s ease infinite;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));
    }
    @keyframes gradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes fadeIn {
      to { opacity: 1; }
    }
    @keyframes fadeOut {
      to { opacity: 0; }
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <div id="hud">Azure Credits: 0</div>
  <div id="level-display">Level 1</div>
  <div id="overlay">
    <div id="message">VIBE CLOUD ISLAND</div>
    <button id="overlay-button" onclick="startGame()">Start</button>
  </div>
  <audio id="collectSound" preload="none"></audio>
  <script>
    const canvas = document.getElementById('gameCanvas');
canvas.setAttribute('tabindex', '0');
canvas.style.outline = 'none';
    const ctx = canvas.getContext('2d');
    const overlay = document.getElementById('overlay');
    const message = document.getElementById('message');
    const overlayButton = document.getElementById('overlay-button');
    const hud = document.getElementById('hud');
    const levelDisplay = document.getElementById('level-display');
    const collectSound = document.getElementById('collectSound');

    // Remove external image dependencies - use simple rectangles instead

    let width, height;
    let gameRunning = false;
    let currentLevel = 1;
    const maxLevel = 5;

    const collected = {
      credits: 0
    };

    const particles = [];
    
    // Animated background elements
    let birds = [];
    let animatedClouds = [];
    let animationTime = 0;

    // Level configurations with vibrant pastel colors and retro-modern aesthetics
    const levelConfigs = {
      1: {
        backgroundColor: 'linear-gradient(to bottom, #ff9ff3, #a8edea, #fed6e3)',
        platformColor: '#ffeaa7',
        platformShadow: '#fdcb6e',
        playerColor: '#ffb6b9',
        cloudColor: '#ffffff',
        platforms: [
          { x: 0, y: 400, width: 800, height: 40 },
          { x: 300, y: 320, width: 120, height: 20 },
          { x: 500, y: 250, width: 100, height: 20 },
          { x: 700, y: 180, width: 120, height: 20 },
          { x: 900, y: 300, width: 150, height: 20 },
          { x: 1120, y: 325, width: 100, height: 20 },
          { x: 1300, y: 350, width: 120, height: 20 },
          { x: 1500, y: 280, width: 120, height: 20 }
        ],
        collectibles: [
          { x: 330, y: 290, collected: false, type: 'credit' },
          { x: 530, y: 220, collected: false, type: 'credit' },
          { x: 730, y: 150, collected: false, type: 'credit' },
          { x: 1150, y: 295, collected: false, type: 'credit' }
        ],
        gate: { x: 1560, y: 240, width: 20, height: 40 }
      },
      2: {
        backgroundColor: 'linear-gradient(to bottom, #ffecd2, #fcb69f, #ff9a9e)',
        platformColor: '#ff7675',
        platformShadow: '#e17055',
        playerColor: '#74b9ff',
        cloudColor: '#ffeaa7',
        platforms: [
          { x: 0, y: 400, width: 600, height: 40 },
          { x: 200, y: 340, width: 100, height: 20 },
          { x: 380, y: 280, width: 100, height: 20 },
          { x: 560, y: 220, width: 100, height: 20 },
          { x: 740, y: 160, width: 100, height: 20 },
          { x: 920, y: 220, width: 120, height: 20 },
          { x: 1120, y: 280, width: 100, height: 20 },
          { x: 1300, y: 340, width: 150, height: 20 }
        ],
        collectibles: [
          { x: 230, y: 310, collected: false, type: 'credit' },
          { x: 410, y: 250, collected: false, type: 'credit' },
          { x: 590, y: 190, collected: false, type: 'credit' },
          { x: 950, y: 190, collected: false, type: 'credit' }
        ],
        gate: { x: 1400, y: 300, width: 20, height: 40 }
      },
      3: {
        backgroundColor: 'linear-gradient(to bottom, #a8edea, #fed6e3, #d299c2)',
        platformColor: '#00b894',
        platformShadow: '#00a085',
        playerColor: '#fd79a8',
        cloudColor: '#dda0dd',
        platforms: [
          { x: 0, y: 400, width: 500, height: 40 },
          { x: 150, y: 320, width: 80, height: 20 },
          { x: 300, y: 260, width: 80, height: 20 },
          { x: 450, y: 200, width: 80, height: 20 },
          { x: 600, y: 140, width: 80, height: 20 },
          { x: 750, y: 200, width: 80, height: 20 },
          { x: 900, y: 260, width: 80, height: 20 },
          { x: 1050, y: 200, width: 80, height: 20 },
          { x: 1200, y: 320, width: 200, height: 20 }
        ],
        collectibles: [
          { x: 180, y: 290, collected: false, type: 'credit' },
          { x: 330, y: 230, collected: false, type: 'credit' },
          { x: 480, y: 170, collected: false, type: 'credit' },
          { x: 780, y: 170, collected: false, type: 'credit' },
          { x: 1080, y: 170, collected: false, type: 'credit' }
        ],
        gate: { x: 1360, y: 280, width: 20, height: 40 }
      },
      4: {
        backgroundColor: 'linear-gradient(to bottom, #fad0c4, #ffd1ff, #a8edea)',
        platformColor: '#fd79a8',
        platformShadow: '#e84393',
        playerColor: '#6c5ce7',
        cloudColor: '#fab1a0',
        platforms: [
          { x: 0, y: 400, width: 400, height: 40 },
          { x: 100, y: 350, width: 60, height: 20 },
          { x: 220, y: 300, width: 60, height: 20 },
          { x: 340, y: 250, width: 60, height: 20 },
          { x: 460, y: 200, width: 60, height: 20 },
          { x: 580, y: 150, width: 60, height: 20 },
          { x: 700, y: 100, width: 60, height: 20 },
          { x: 820, y: 150, width: 60, height: 20 },
          { x: 940, y: 200, width: 60, height: 20 },
          { x: 1060, y: 250, width: 60, height: 20 },
          { x: 1180, y: 300, width: 60, height: 20 },
          { x: 1300, y: 350, width: 200, height: 20 }
        ],
        collectibles: [
          { x: 130, y: 320, collected: false, type: 'credit' },
          { x: 250, y: 270, collected: false, type: 'credit' },
          { x: 370, y: 220, collected: false, type: 'credit' },
          { x: 610, y: 120, collected: false, type: 'credit' },
          { x: 730, y: 70, collected: false, type: 'credit' },
          { x: 970, y: 170, collected: false, type: 'credit' }
        ],
        gate: { x: 1460, y: 310, width: 20, height: 40 }
      },
      5: {
        backgroundColor: 'linear-gradient(to bottom, #a29bfe, #ffecd2, #ff9ff3)',
        platformColor: '#00cec9',
        platformShadow: '#00b894',
        playerColor: '#ff7675',
        cloudColor: '#fd79a8',
        platforms: [
          { x: 0, y: 400, width: 300, height: 40 },
          { x: 80, y: 360, width: 50, height: 20 },
          { x: 180, y: 320, width: 50, height: 20 },
          { x: 280, y: 280, width: 50, height: 20 },
          { x: 380, y: 240, width: 50, height: 20 },
          { x: 480, y: 200, width: 50, height: 20 },
          { x: 580, y: 160, width: 50, height: 20 },
          { x: 680, y: 120, width: 50, height: 20 },
          { x: 780, y: 80, width: 50, height: 20 },
          { x: 880, y: 120, width: 50, height: 20 },
          { x: 980, y: 160, width: 50, height: 20 },
          { x: 1080, y: 200, width: 50, height: 20 },
          { x: 1180, y: 240, width: 50, height: 20 },
          { x: 1280, y: 280, width: 50, height: 20 },
          { x: 1380, y: 320, width: 50, height: 20 },
          { x: 1480, y: 360, width: 200, height: 20 }
        ],
        collectibles: [
          { x: 110, y: 330, collected: false, type: 'credit' },
          { x: 210, y: 290, collected: false, type: 'credit' },
          { x: 310, y: 250, collected: false, type: 'credit' },
          { x: 510, y: 170, collected: false, type: 'credit' },
          { x: 710, y: 90, collected: false, type: 'credit' },
          { x: 810, y: 50, collected: false, type: 'credit' },
          { x: 1010, y: 130, collected: false, type: 'credit' }
        ],
        gate: { x: 1640, y: 320, width: 20, height: 40 }
      }
    };

    function resizeCanvas() {
      width = window.innerWidth;
      height = window.innerHeight;
      canvas.width = width;
      canvas.height = height;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    const player = {
      x: 100,
      y: 100,
      vx: 0,
      vy: 0,
      width: 32,
      height: 32,
      grounded: false
    };

    const gravity = 0.5;
    const moveSpeed = 3;
    const jumpForce = -10;

    let cameraX = 0;

    const clouds = [
      { x: 0, y: 50, width: 200, height: 60 },
      { x: 400, y: 100, width: 180, height: 50 },
      { x: 900, y: 70, width: 220, height: 70 },
      { x: 1300, y: 90, width: 160, height: 55 }
    ];

    // Current level platforms and collectibles (will be updated based on currentLevel)
    let platforms = [];
    let collectibles = [];
    let gate = null;
    let gateVisible = false;

    let keys = { left: false, right: false, up: false };

    canvas.addEventListener('touchstart', (e) => {
      const touch = e.touches[0];
      if (touch.clientX < width / 3) keys.left = true;
      else if (touch.clientX > (2 * width) / 3) keys.right = true;
      else keys.up = true;
    });
    canvas.addEventListener('touchend', () => {
      keys.left = false;
      keys.right = false;
      keys.up = false;
    });

    // Add desktop keyboard support
    window.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft' || e.key === 'a') {
        keys.left = true;
        e.preventDefault();
      }
      if (e.key === 'ArrowRight' || e.key === 'd') {
        keys.right = true;
        e.preventDefault();
      }
      if (e.key === 'ArrowUp' || e.key === 'w' || e.key === ' ') {
        keys.up = true;
        e.preventDefault();
      }
    });
    window.addEventListener('keyup', (e) => {
      if (e.key === 'ArrowLeft' || e.key === 'a') {
        keys.left = false;
        e.preventDefault();
      }
      if (e.key === 'ArrowRight' || e.key === 'd') {
        keys.right = false;
        e.preventDefault();
      }
      if (e.key === 'ArrowUp' || e.key === 'w' || e.key === ' ') {
        keys.up = false;
        e.preventDefault();
      }
    });

    function updateHUD() {
      hud.innerText = `Azure Credits: ${collected.credits}`;
    }

    function updateLevelDisplay() {
      levelDisplay.innerText = `Level ${currentLevel}`;
    }

    function loadLevel(level) {
      const config = levelConfigs[level];
      if (!config) return;
      
      platforms = [...config.platforms];
      collectibles = config.collectibles.map(c => ({ ...c, collected: false }));
      gate = { ...config.gate };
      gateVisible = false;
      
      // Update background color
      document.body.style.background = config.backgroundColor;
      
      updateLevelDisplay();
    }

    function checkLevelComplete() {
      const totalCollectibles = collectibles.length;
      const collectedCount = collectibles.filter(c => c.collected).length;
      
      if (collectedCount === totalCollectibles) {
        // Show the gate when all collectibles are collected
        gateVisible = true;
      }
    }

    function createParticles(x, y, color) {
      for (let i = 0; i < 10; i++) {
        particles.push({
          x: x + 8,
          y: y + 8,
          vx: (Math.random() - 0.5) * 2,
          vy: (Math.random() - 0.5) * 2,
          life: 30,
          color: color
        });
      }
    }

    function update() {
      if (keys.left) player.vx = -moveSpeed;
      else if (keys.right) player.vx = moveSpeed;
      else player.vx = 0;

      if (keys.up && player.grounded) {
        player.vy = jumpForce;
        player.grounded = false;
      }

      player.vy += gravity;
      player.x += player.vx;
      player.y += player.vy;

      player.grounded = false;
      for (const p of platforms) {
        if (
          player.x < p.x + p.width &&
          player.x + player.width > p.x &&
          player.y < p.y + p.height &&
          player.y + player.height > p.y
        ) {
          if (player.vy > 0) {
            player.y = p.y - player.height;
            player.vy = 0;
            player.grounded = true;
          }
        }
      }

      for (const c of collectibles) {
        if (!c.collected &&
            player.x < c.x + 16 &&
            player.x + player.width > c.x &&
            player.y < c.y + 16 &&
            player.y + player.height > c.y) {
          c.collected = true;
          collected.credits++;
          updateHUD();
          // Audio removed for compatibility
          createParticles(c.x, c.y, '#fff');
          checkLevelComplete();
        }
      }

      // Check gate collision
      if (gateVisible && gate &&
          player.x < gate.x + gate.width &&
          player.x + player.width > gate.x &&
          player.y < gate.y + gate.height &&
          player.y + player.height > gate.y) {
        
        if (currentLevel < maxLevel) {
          // Advance to next level
          currentLevel++;
          resetPlayer();
          loadLevel(currentLevel);
          
          // Show level complete message briefly
          message.innerText = `Level ${currentLevel - 1} Complete! Starting Level ${currentLevel} - Azure Credits: ${collected.credits}`;
          overlay.style.display = 'flex';
          overlay.classList.remove('fade-out');
          
          setTimeout(() => {
            overlay.classList.add('fade-out');
            setTimeout(() => {
              overlay.style.display = 'none';
              gameRunning = true;
            }, 500);
          }, 2000);
        } else {
          // Game complete!
          gameRunning = false;
          message.innerText = 'ðŸ† All levels completed! You are an Azure master! ðŸ†';
          overlayButton.innerText = 'Play Again';
          overlay.classList.remove('fade-out');
          overlay.style.display = 'flex';
        }
      }

      for (const p of particles) {
        p.x += p.vx;
        p.y += p.vy;
        p.life--;
      }

      while (particles.length > 0 && particles[0].life <= 0) {
        particles.shift();
      }

      if (player.y > height) {
        endGame();
      }

      cameraX = player.x - width / 2 + player.width / 2;
    }

    function drawPuffyCloud(x, y, radiusX, radiusY, color) {
      ctx.fillStyle = color;
      ctx.shadowColor = 'rgba(0,0,0,0.1)';
      ctx.shadowBlur = 8;
      ctx.shadowOffsetX = 2;
      ctx.shadowOffsetY = 2;
      
      // Main cloud body
      ctx.beginPath();
      ctx.ellipse(x, y, radiusX, radiusY, 0, 0, Math.PI * 2);
      ctx.fill();
      
      // Cloud puffs for depth
      const puffSize = radiusX * 0.6;
      ctx.beginPath();
      ctx.ellipse(x - radiusX * 0.5, y - radiusY * 0.3, puffSize, puffSize, 0, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.beginPath();
      ctx.ellipse(x + radiusX * 0.5, y - radiusY * 0.3, puffSize, puffSize, 0, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.beginPath();
      ctx.ellipse(x - radiusX * 0.3, y + radiusY * 0.4, puffSize * 0.8, puffSize * 0.8, 0, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.beginPath();
      ctx.ellipse(x + radiusX * 0.3, y + radiusY * 0.4, puffSize * 0.8, puffSize * 0.8, 0, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.shadowColor = 'transparent';
      ctx.shadowBlur = 0;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 0;
    }

    function drawAnimatedClouds(config) {
      // Generate animated clouds if needed
      if (animatedClouds.length === 0) {
        for (let i = 0; i < 8; i++) {
          animatedClouds.push({
            x: Math.random() * width * 3,
            y: Math.random() * height * 0.6 + 50,
            size: Math.random() * 40 + 20,
            speed: Math.random() * 0.5 + 0.2,
            opacity: Math.random() * 0.4 + 0.3
          });
        }
      }
      
      for (const cloud of animatedClouds) {
        cloud.x += cloud.speed;
        if (cloud.x > width * 3) cloud.x = -100;
        
        ctx.globalAlpha = cloud.opacity;
        drawPuffyCloud(cloud.x, cloud.y, cloud.size, cloud.size * 0.6, config.cloudColor);
      }
      ctx.globalAlpha = 1;
    }

    function drawBirds() {
      // Generate birds if needed
      if (birds.length === 0) {
        for (let i = 0; i < 5; i++) {
          birds.push({
            x: Math.random() * width * 2,
            y: Math.random() * height * 0.4 + 50,
            speed: Math.random() * 1 + 0.5,
            wingPhase: Math.random() * Math.PI * 2,
            size: Math.random() * 8 + 4
          });
        }
      }
      
      ctx.fillStyle = 'rgba(0,0,0,0.6)';
      for (const bird of birds) {
        bird.x += bird.speed;
        bird.wingPhase += 0.3;
        if (bird.x > width * 2) bird.x = -50;
        
        // Simple bird shape with animated wings
        const wingOffset = Math.sin(bird.wingPhase) * 3;
        ctx.fillRect(bird.x - bird.size/2, bird.y + wingOffset, bird.size, 2);
        ctx.fillRect(bird.x + bird.size/2, bird.y - wingOffset, bird.size, 2);
      }
    }

    function drawPlatformWith3D(platform, config) {
      const depth = 6;
      
      // Shadow
      ctx.fillStyle = 'rgba(0,0,0,0.2)';
      ctx.fillRect(platform.x + depth, platform.y + depth, platform.width, platform.height);
      
      // Platform side (3D depth)
      ctx.fillStyle = config.platformShadow;
      ctx.fillRect(platform.x, platform.y + depth, platform.width, platform.height);
      
      // Platform top with gradient
      const gradient = ctx.createLinearGradient(0, platform.y, 0, platform.y + platform.height);
      gradient.addColorStop(0, config.platformColor);
      gradient.addColorStop(1, config.platformShadow);
      ctx.fillStyle = gradient;
      ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
      
      // Highlight on top edge
      ctx.fillStyle = 'rgba(255,255,255,0.3)';
      ctx.fillRect(platform.x, platform.y, platform.width, 2);
    }

    function drawEnhancedCollectible(collectible) {
      const pulseSize = Math.sin(animationTime * 4) * 2 + 16;
      
      // Glow effect
      ctx.shadowColor = '#ffd700';
      ctx.shadowBlur = 15;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 0;
      
      // Main collectible with gradient
      const gradient = ctx.createRadialGradient(
        collectible.x + 8, collectible.y + 8, 0,
        collectible.x + 8, collectible.y + 8, 12
      );
      gradient.addColorStop(0, '#ffd700');
      gradient.addColorStop(0.7, '#ffb347');
      gradient.addColorStop(1, '#ff8c00');
      
      ctx.fillStyle = gradient;
      ctx.beginPath();
      ctx.arc(collectible.x + 8, collectible.y + 8, pulseSize / 2, 0, Math.PI * 2);
      ctx.fill();
      
      // Remove shadow
      ctx.shadowColor = 'transparent';
      ctx.shadowBlur = 0;
      
      // $ symbol with better styling
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 12px monospace';
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 2;
      ctx.strokeText('$', collectible.x + 4, collectible.y + 12);
      ctx.fillText('$', collectible.x + 4, collectible.y + 12);
    }

    function drawEnhancedGate(gate) {
      // Gate with 3D effect and glow
      ctx.shadowColor = '#ffd700';
      ctx.shadowBlur = 20;
      
      const gradient = ctx.createLinearGradient(gate.x, gate.y, gate.x + gate.width, gate.y);
      gradient.addColorStop(0, '#ffd700');
      gradient.addColorStop(0.5, '#ffed4e');
      gradient.addColorStop(1, '#ffd700');
      
      ctx.fillStyle = gradient;
      ctx.fillRect(gate.x, gate.y, gate.width, gate.height);
      
      ctx.shadowColor = 'transparent';
      ctx.shadowBlur = 0;
      
      // Gate decoration
      ctx.fillStyle = '#000';
      ctx.font = '12px monospace';
      ctx.fillText('ðŸšª', gate.x - 5, gate.y - 5);
      
      ctx.fillStyle = '#000';
      ctx.font = '8px monospace';
      ctx.fillText('GATE', gate.x - 5, gate.y + gate.height + 12);
    }

    function drawEnhancedParticle(particle) {
      ctx.globalAlpha = particle.life / 30;
      
      // Create radial gradient for particle
      const gradient = ctx.createRadialGradient(
        particle.x, particle.y, 0,
        particle.x, particle.y, 4
      );
      gradient.addColorStop(0, particle.color);
      gradient.addColorStop(1, 'transparent');
      
      ctx.fillStyle = gradient;
      ctx.beginPath();
      ctx.arc(particle.x, particle.y, 4, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.globalAlpha = 1;
    }

    function drawPlayer() {
      // Enhanced cloud character with depth and shading
      const centerX = player.x + player.width / 2;
      const centerY = player.y + player.height / 2;
      
      // Shadow beneath the cloud
      ctx.fillStyle = 'rgba(0,0,0,0.2)';
      ctx.beginPath();
      ctx.ellipse(centerX, centerY + 18, 16, 4, 0, 0, Math.PI * 2);
      ctx.fill();
      
      // Cloud body with gradient shading
      const gradient = ctx.createRadialGradient(
        centerX - 4, centerY - 4, 0,
        centerX, centerY, 20
      );
      gradient.addColorStop(0, '#ffffff');
      gradient.addColorStop(0.7, '#f0f8ff');
      gradient.addColorStop(1, '#e6f3ff');
      
      ctx.fillStyle = gradient;
      ctx.shadowColor = 'rgba(0,0,0,0.1)';
      ctx.shadowBlur = 8;
      ctx.shadowOffsetX = 2;
      ctx.shadowOffsetY = 2;
      
      // Main cloud body (larger central circle)
      ctx.beginPath();
      ctx.arc(centerX, centerY, 14, 0, Math.PI * 2);
      ctx.fill();
      
      // Cloud puffs around the main body with slight variations
      ctx.beginPath();
      ctx.arc(centerX - 8, centerY - 4, 8, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.beginPath();
      ctx.arc(centerX + 8, centerY - 4, 8, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.beginPath();
      ctx.arc(centerX - 6, centerY + 6, 7, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.beginPath();
      ctx.arc(centerX + 6, centerY + 6, 7, 0, Math.PI * 2);
      ctx.fill();
      
      // Remove shadow for face elements
      ctx.shadowColor = 'transparent';
      ctx.shadowBlur = 0;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 0;
      
      // Enhanced 8-bit style face with glow
      ctx.fillStyle = '#000000';
      ctx.shadowColor = 'rgba(255,255,255,0.5)';
      ctx.shadowBlur = 2;
      
      // Eyes (small squares for retro look with slight glow)
      ctx.fillRect(centerX - 6, centerY - 4, 2, 2);
      ctx.fillRect(centerX + 4, centerY - 4, 2, 2);
      
      // Happy smile (enhanced arc)
      ctx.strokeStyle = '#000000';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(centerX, centerY + 2, 4, 0, Math.PI);
      ctx.stroke();
      
      // Reset shadow
      ctx.shadowColor = 'transparent';
      ctx.shadowBlur = 0;
    }

    function draw() {
      const config = levelConfigs[currentLevel];
      animationTime += 0.02;
      
      // Draw gradient background
      const gradient = ctx.createLinearGradient(0, 0, 0, height);
      const colors = config.backgroundColor.match(/linear-gradient\(to bottom, ([^)]+)\)/)[1].split(', ');
      gradient.addColorStop(0, colors[0]);
      gradient.addColorStop(0.5, colors[1]);
      gradient.addColorStop(1, colors[2]);
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, width, height);

      // Draw animated background clouds with parallax
      ctx.save();
      ctx.translate(-cameraX * 0.3, 0);
      drawAnimatedClouds(config);
      ctx.restore();

      // Draw flying birds
      ctx.save();
      ctx.translate(-cameraX * 0.4, 0);
      drawBirds();
      ctx.restore();

      // Draw static background clouds with parallax
      ctx.save();
      ctx.translate(-cameraX * 0.5, 0);
      ctx.fillStyle = config.cloudColor;
      for (const c of clouds) {
        drawPuffyCloud(c.x, c.y, c.width / 2, c.height / 2, config.cloudColor);
      }
      ctx.restore();

      ctx.save();
      ctx.translate(-cameraX, 0);

      // Draw platforms with 3D depth and shadows
      for (const p of platforms) {
        drawPlatformWith3D(p, config);
      }

      // Draw player as enhanced cloud character
      drawPlayer();

      // Draw collectibles with glow effects
      for (const c of collectibles) {
        if (!c.collected) {
          drawEnhancedCollectible(c);
        }
      }

      // Draw gate if visible
      if (gateVisible && gate) {
        drawEnhancedGate(gate);
      }

      // Draw enhanced particles
      for (const p of particles) {
        drawEnhancedParticle(p);
      }

      ctx.restore();
    }

    function gameLoop() {
      if (!gameRunning) return;
      update();
      draw();
      requestAnimationFrame(gameLoop);
    }

    function startGame() {
      // Update message to show current credits
      message.innerText = `Level ${currentLevel} - Azure Credits: ${collected.credits}`;
      
      overlay.classList.add('fade-out');
      setTimeout(() => {
        overlay.style.display = 'none';
        gameRunning = true;
        canvas.focus(); // Ensure canvas has focus when game starts
        resetGame();
        gameLoop(); // Start the game loop directly
      }, 500);
    }

    function endGame() {
      gameRunning = false;
      message.innerText = 'GAME OVER';
      overlayButton.innerText = 'Restart';
      overlay.classList.remove('fade-out');
      overlay.style.display = 'flex';
    }

    function resetPlayer() {
      player.x = 100;
      player.y = 400 - player.height;
      player.vx = 0;
      player.vy = 0;
      // Don't reset credits - keep them across levels
      particles.length = 0;
      updateHUD();
      for (const c of collectibles) {
        c.collected = false;
      }
    }

    function resetGame() {
      currentLevel = 1;
      collected.credits = 0; // Reset credits only when starting a new game
      loadLevel(currentLevel);
      resetPlayer();
    }
  
    window.addEventListener('load', () => {
      loadLevel(currentLevel); // Initialize first level
      overlay.style.opacity = '1';
      canvas.focus();
      window.startGame = startGame;
    });
  </script>
</body>
</html>
